<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè∑Ô∏è Gerenciar Promo√ß√µes - Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="maintenance-check.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .sidebar-gradient { background: linear-gradient(135deg, #1f2937, #374151, #4b5563); }
    </style>
</head>
<body class="bg-gray-100">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="w-64 sidebar-gradient text-white">
            <div class="p-6">
                <div class="flex items-center space-x-3">
                    <span class="text-2xl">üî•</span>
                    <div>
                        <h2 class="font-bold text-lg">Promo√ß√µes</h2>
                        <p class="text-gray-300 text-sm">Admin Panel</p>
                    </div>
                </div>
            </div>
            
            <nav class="mt-8">
                <a href="admin-dashboard.html" class="flex items-center px-6 py-3 text-gray-300 hover:text-white hover:bg-gray-700">
                    <span class="mr-3">üìä</span> Dashboard
                </a>
                <a href="admin-promotions.html" class="flex items-center px-6 py-3 text-white bg-gray-700">
                    <span class="mr-3">üè∑Ô∏è</span> Promo√ß√µes
                </a>
                <a href="admin-ia-generator.html" class="flex items-center px-6 py-3 text-gray-300 hover:text-white hover:bg-gray-700">
                    <span class="mr-3">ü§ñ</span> IA Generator
                </a>
                <a href="admin-whatsapp.html" class="flex items-center px-6 py-3 text-gray-300 hover:text-white hover:bg-gray-700">
                    <span class="mr-3">üì±</span> WhatsApp
                </a>
                <a href="admin-scraping.html" class="flex items-center px-6 py-3 text-gray-300 hover:text-white hover:bg-gray-700">
                    <span class="mr-3">üï∑Ô∏è</span> Scraping
                </a>
                <a href="admin-settings.html" class="flex items-center px-6 py-3 text-gray-300 hover:text-white hover:bg-gray-700">
                    <span class="mr-3">‚öôÔ∏è</span> Configura√ß√µes
                </a>
                <a href="admin-analytics.html" class="flex items-center px-6 py-3 text-gray-300 hover:text-white hover:bg-gray-700">
                    <span class="mr-3">üìà</span> Analytics
                </a>
                <a href="admin-logs.html" class="flex items-center px-6 py-3 text-gray-300 hover:text-white hover:bg-gray-700">
                    <span class="mr-3">üîß</span> Logs
                </a>
                <a href="index.html" class="flex items-center px-6 py-3 text-gray-300 hover:text-white hover:bg-gray-700">
                    <span class="mr-3">üåê</span> Ver Site
                </a>
                <a href="admin-login.html" class="flex items-center px-6 py-3 text-red-300 hover:text-red-200 hover:bg-red-700">
                    <span class="mr-3">üö™</span> Logout
                </a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Header -->
            <header class="bg-white shadow-sm border-b border-gray-200">
                <div class="flex items-center justify-between px-6 py-4">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">üè∑Ô∏è Gerenciar Promo√ß√µes</h1>
                        <p class="text-gray-600">Adicionar, editar e gerenciar todas as promo√ß√µes</p>
                        <div class="stats-display mt-2">
                            <div class="flex items-center space-x-6 text-sm text-gray-600">
                                <span>‚è≥ Carregando estat√≠sticas...</span>
                            </div>
                        </div>
                    </div>
                    <button class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        ‚ûï Nova Promo√ß√£o
                    </button>
                </div>
            </header>

            <!-- Content -->
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
                <!-- Filters -->
                <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                    <div class="flex flex-wrap items-center space-x-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">üîç Buscar</label>
                            <input type="text" placeholder="Buscar promo√ß√µes..." class="px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">üìÇ Categoria</label>
                            <select class="px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                                <option>Todas</option>
                                <option>Eletr√¥nicos</option>
                                <option>Casa</option>
                                <option>Moda</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">üè™ Loja</label>
                            <select class="px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                                <option>Todas</option>
                                <option>Amazon</option>
                                <option>Mercado Livre</option>
                                <option>Americanas</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">üìä Status</label>
                            <select class="px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                                <option>Todos</option>
                                <option>Ativo</option>
                                <option>Inativo</option>
                                <option>Expirado</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Promotions Table -->
                <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">Lista de Promo√ß√µes</h3>
                        <p class="text-gray-600">1,247 promo√ß√µes encontradas</p>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produto</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Loja</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pre√ßo</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Desconto</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">IA</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <!-- Promotion 1 -->
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center">
                                            <img src="https://via.placeholder.com/60" alt="Produto" class="w-10 h-10 rounded-md">
                                            <div class="ml-4">
                                                <div class="text-sm font-medium text-gray-900">Smartphone Galaxy S24</div>
                                                <div class="text-sm text-gray-500">Eletr√¥nicos</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">Amazon</td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm text-gray-900">
                                            <span class="line-through text-gray-400">R$ 2.999,00</span><br>
                                            <span class="font-bold text-green-600">R$ 1.899,00</span>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                            37% OFF
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                            ‚úÖ Ativo
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <button class="text-purple-600 hover:text-purple-900 text-sm">ü§ñ Gerar</button>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                        <div class="flex space-x-2">
                                            <button class="text-blue-600 hover:text-blue-900">‚úèÔ∏è</button>
                                            <button class="text-green-600 hover:text-green-900">üì§</button>
                                            <button class="text-red-600 hover:text-red-900">üóëÔ∏è</button>
                                        </div>
                                    </td>
                                </tr>

                                <!-- Promotion 2 -->
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center">
                                            <img src="https://via.placeholder.com/60" alt="Produto" class="w-10 h-10 rounded-md">
                                            <div class="ml-4">
                                                <div class="text-sm font-medium text-gray-900">Notebook Gamer RTX</div>
                                                <div class="text-sm text-gray-500">Eletr√¥nicos</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">Mercado Livre</td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm text-gray-900">
                                            <span class="line-through text-gray-400">R$ 4.999,00</span><br>
                                            <span class="font-bold text-green-600">R$ 2.999,00</span>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                            40% OFF
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                            ‚úÖ Ativo
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="text-green-600 text-sm">‚úÖ Gerada</span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                        <div class="flex space-x-2">
                                            <button class="text-blue-600 hover:text-blue-900">‚úèÔ∏è</button>
                                            <button class="text-green-600 hover:text-green-900">üì§</button>
                                            <button class="text-red-600 hover:text-red-900">üóëÔ∏è</button>
                                        </div>
                                    </td>
                                </tr>

                                <!-- Promotion 3 -->
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center">
                                            <img src="https://via.placeholder.com/60" alt="Produto" class="w-10 h-10 rounded-md">
                                            <div class="ml-4">
                                                <div class="text-sm font-medium text-gray-900">Smart TV 55" 4K</div>
                                                <div class="text-sm text-gray-500">Eletr√¥nicos</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">Americanas</td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm text-gray-900">
                                            <span class="line-through text-gray-400">R$ 2.499,00</span><br>
                                            <span class="font-bold text-green-600">R$ 1.799,00</span>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                            28% OFF
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                            ‚è≥ Expira em 2h
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <button class="text-purple-600 hover:text-purple-900 text-sm">ü§ñ Gerar</button>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                        <div class="flex space-x-2">
                                            <button class="text-blue-600 hover:text-blue-900">‚úèÔ∏è</button>
                                            <button class="text-green-600 hover:text-green-900">üì§</button>
                                            <button class="text-red-600 hover:text-red-900">üóëÔ∏è</button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="px-6 py-3 border-t border-gray-200">
                        <div class="flex items-center justify-between">
                            <div class="text-sm text-gray-700">
                                Mostrando <span class="font-medium">1</span> a <span class="font-medium">10</span> de <span class="font-medium">1,247</span> resultados
                            </div>
                            <div class="flex items-center space-x-2">
                                <button class="px-3 py-2 text-sm text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">Anterior</button>
                                <button class="px-3 py-2 text-sm text-white bg-blue-600 border border-blue-600 rounded-md hover:bg-blue-700">1</button>
                                <button class="px-3 py-2 text-sm text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">2</button>
                                <button class="px-3 py-2 text-sm text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">3</button>
                                <button class="px-3 py-2 text-sm text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">Pr√≥ximo</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bulk Actions -->
                <div class="mt-6 bg-white rounded-lg shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">‚ö° A√ß√µes em Lote</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <button class="bg-purple-600 text-white p-3 rounded-lg hover:bg-purple-700 transition-colors">
                            <span class="text-xl">ü§ñ</span>
                            <div class="mt-2 text-sm font-semibold">Gerar Descri√ß√µes IA</div>
                        </button>
                        <button class="bg-green-600 text-white p-3 rounded-lg hover:bg-green-700 transition-colors">
                            <span class="text-xl">üì±</span>
                            <div class="mt-2 text-sm font-semibold">Enviar WhatsApp</div>
                        </button>
                        <button class="bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition-colors">
                            <span class="text-xl">üìä</span>
                            <div class="mt-2 text-sm font-semibold">Exportar Dados</div>
                        </button>
                        <button class="bg-orange-600 text-white p-3 rounded-lg hover:bg-orange-700 transition-colors">
                            <span class="text-xl">üîÑ</span>
                            <div class="mt-2 text-sm font-semibold">Atualizar Pre√ßos</div>
                        </button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // ============================================
        // üöÄ SISTEMA DE PROMO√á√ïES COM BACKEND REAL
        // ============================================

        class PromotionsManager {
            constructor() {
                this.baseUrl = 'http://localhost:3002/api';
                this.promotions = [];
                this.currentPage = 1;
                this.totalPromotions = 0;
                this.filters = {
                    search: '',
                    category: 'all',
                    store: 'all', 
                    status: 'all'
                };
                
                console.log('üè∑Ô∏è Promotions Manager iniciado');
                this.init();
            }

            async init() {
                await this.loadPromotions();
                await this.loadStats();
                this.setupEventListeners();
                this.runTests();
            }

            // ========================================
            // üì° COMUNICA√á√ÉO COM BACKEND
            // ========================================

            async apiRequest(endpoint, options = {}) {
                const url = `${this.baseUrl}${endpoint}`;
                
                try {
                    const response = await fetch(url, {
                        headers: {
                            'Content-Type': 'application/json',
                            ...options.headers
                        },
                        ...options
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    return data;

                } catch (error) {
                    console.error(`‚ùå Erro na API ${endpoint}:`, error);
                    
                    // Fallback para localStorage em caso de erro
                    if (endpoint === '/promotions') {
                        return this.getFallbackData();
                    }
                    throw error;
                }
            }

            async loadPromotions() {
                try {
                    const queryParams = new URLSearchParams({
                        page: this.currentPage,
                        limit: 10,
                        ...this.filters
                    });

                    const result = await this.apiRequest(`/promotions?${queryParams}`);
                    
                    if (result.success) {
                        this.promotions = result.data.promotions;
                        this.totalPromotions = result.data.pagination.total;
                        this.renderPromotions();
                        this.updatePagination(result.data.pagination);
                        
                        console.log(`‚úÖ ${this.promotions.length} promo√ß√µes carregadas do backend`);
                    }

                } catch (error) {
                    console.error('‚ùå Erro ao carregar promo√ß√µes:', error);
                    this.showNotification('Erro ao carregar promo√ß√µes. Usando dados offline.', 'error');
                }
            }

            async loadStats() {
                try {
                    const result = await this.apiRequest('/promotions/stats');
                    
                    if (result.success) {
                        this.updateStatsDisplay(result.data);
                        console.log('‚úÖ Estat√≠sticas carregadas do backend');
                    }

                } catch (error) {
                    console.error('‚ùå Erro ao carregar estat√≠sticas:', error);
                }
            }

            async generateAIText(promotionId) {
                try {
                    const result = await this.apiRequest('/promotions/generate-ai', {
                        method: 'POST',
                        body: JSON.stringify({ promotionId })
                    });

                    if (result.success) {
                        this.showNotification(`ü§ñ IA: ${result.data.generatedText}`, 'success');
                        console.log(`‚úÖ Texto IA gerado para promo√ß√£o ${promotionId}`);
                        return result.data.generatedText;
                    }

                } catch (error) {
                    console.error('‚ùå Erro ao gerar texto IA:', error);
                    this.showNotification('Erro ao gerar texto com IA', 'error');
                }
            }

            // ========================================
            // üé® RENDERIZA√á√ÉO DA INTERFACE
            // ========================================

            renderPromotions() {
                const tbody = document.querySelector('tbody');
                if (!tbody) return;

                tbody.innerHTML = this.promotions.map(promo => `
                    <tr class="hover:bg-gray-50" data-promo-id="${promo.id}">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <img src="${promo.imageUrl}" alt="${promo.title}" class="w-10 h-10 rounded-md object-cover">
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">${promo.title}</div>
                                    <div class="text-sm text-gray-500">${promo.category}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${promo.store}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">
                                <span class="line-through text-gray-400">R$ ${promo.originalPrice.toFixed(2)}</span><br>
                                <span class="font-bold text-green-600">R$ ${promo.promoPrice.toFixed(2)}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                ${promo.discountPercent}% OFF
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            ${this.getStatusBadge(promo.status, promo.expiresAt)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            ${promo.aiGenerated ? 
                                '<span class="text-green-600 text-sm">‚úÖ Gerada</span>' : 
                                '<button class="text-purple-600 hover:text-purple-900 text-sm generate-ai-btn">ü§ñ Gerar</button>'
                            }
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <div class="flex space-x-2">
                                <button class="text-blue-600 hover:text-blue-900 edit-btn" title="Editar">‚úèÔ∏è</button>
                                <button class="text-green-600 hover:text-green-900 share-btn" title="Compartilhar">üì§</button>
                                <button class="text-red-600 hover:text-red-900 delete-btn" title="Excluir">üóëÔ∏è</button>
                            </div>
                        </td>
                    </tr>
                `).join('');

                // Atualizar contador total
                const totalElement = document.querySelector('.text-gray-600');
                if (totalElement) {
                    totalElement.textContent = `${this.totalPromotions} promo√ß√µes encontradas`;
                }
            }

            getStatusBadge(status, expiresAt) {
                const now = new Date();
                const expires = new Date(expiresAt);
                const hoursUntilExpiry = (expires - now) / (1000 * 60 * 60);

                if (status === 'active') {
                    if (hoursUntilExpiry <= 2) {
                        return '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">‚è≥ Expira em breve</span>';
                    }
                    return '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">‚úÖ Ativo</span>';
                } else if (status === 'inactive') {
                    return '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">‚ùå Expirado</span>';
                } else if (status === 'expiring_soon') {
                    const hours = Math.max(0, Math.ceil(hoursUntilExpiry));
                    return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">‚è≥ Expira em ${hours}h</span>`;
                }
                
                return '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">‚ùì Desconhecido</span>';
            }

            updateStatsDisplay(stats) {
                // Atualizar header se existir elemento de estat√≠sticas
                const headerStats = document.querySelector('.stats-display');
                if (headerStats) {
                    headerStats.innerHTML = `
                        <div class="flex items-center space-x-6 text-sm text-gray-600">
                            <span>üìä Total: ${stats.totalPromotions}</span>
                            <span>‚úÖ Ativas: ${stats.activePromotions}</span>
                            <span>üí∞ Desconto M√©dio: ${stats.averageDiscount}%</span>
                        </div>
                    `;
                }
            }

            updatePagination(pagination) {
                const paginationContainer = document.querySelector('.flex.items-center.justify-between');
                if (!paginationContainer) return;

                const totalText = paginationContainer.querySelector('.text-sm.text-gray-700');
                if (totalText) {
                    const start = (pagination.page - 1) * pagination.limit + 1;
                    const end = Math.min(pagination.page * pagination.limit, pagination.total);
                    totalText.innerHTML = `Mostrando <span class="font-medium">${start}</span> a <span class="font-medium">${end}</span> de <span class="font-medium">${pagination.total}</span> resultados`;
                }
            }

            // ========================================
            // üéõÔ∏è EVENT LISTENERS
            // ========================================

            setupEventListeners() {
                // Filtros
                const searchInput = document.querySelector('input[placeholder="Buscar promo√ß√µes..."]');
                const categorySelect = document.querySelector('select:nth-of-type(1)');
                const storeSelect = document.querySelector('select:nth-of-type(2)');
                const statusSelect = document.querySelector('select:nth-of-type(3)');

                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        this.filters.search = e.target.value;
                        this.debounce(() => this.loadPromotions(), 300);
                    });
                }

                if (categorySelect) {
                    categorySelect.addEventListener('change', (e) => {
                        this.filters.category = e.target.value.toLowerCase();
                        this.loadPromotions();
                    });
                }

                if (storeSelect) {
                    storeSelect.addEventListener('change', (e) => {
                        this.filters.store = e.target.value.toLowerCase();
                        this.loadPromotions();
                    });
                }

                if (statusSelect) {
                    statusSelect.addEventListener('change', (e) => {
                        this.filters.status = e.target.value.toLowerCase();
                        this.loadPromotions();
                    });
                }

                // Bot√µes de a√ß√£o
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('generate-ai-btn')) {
                        const promoId = e.target.closest('tr').dataset.promoId;
                        this.generateAIText(promoId);
                    } else if (e.target.classList.contains('edit-btn')) {
                        this.showNotification('‚úèÔ∏è Fun√ß√£o de edi√ß√£o em desenvolvimento', 'info');
                    } else if (e.target.classList.contains('share-btn')) {
                        this.sharePromotion(e.target.closest('tr').dataset.promoId);
                    } else if (e.target.classList.contains('delete-btn')) {
                        this.deletePromotion(e.target.closest('tr').dataset.promoId);
                    }
                });

                // A√ß√µes em lote
                const bulkButtons = document.querySelectorAll('.bg-purple-600, .bg-green-600, .bg-blue-600, .bg-orange-600');
                bulkButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const buttonText = e.target.textContent;
                        if (buttonText.includes('IA')) {
                            this.bulkGenerateAI();
                        } else if (buttonText.includes('WhatsApp')) {
                            this.bulkSendWhatsApp();
                        } else if (buttonText.includes('Exportar')) {
                            this.exportData();
                        } else if (buttonText.includes('Atualizar')) {
                            this.updatePrices();
                        }
                    });
                });
            }

            // ========================================
            // üîß FUNCIONALIDADES
            // ========================================

            sharePromotion(promoId) {
                const promo = this.promotions.find(p => p.id === promoId);
                if (promo) {
                    const message = `üî• PROMO√á√ÉO IMPERD√çVEL!\n\n${promo.title}\nüí∞ De R$ ${promo.originalPrice.toFixed(2)} por R$ ${promo.promoPrice.toFixed(2)}\nüî• ${promo.discountPercent}% de desconto!\n\nüõí ${promo.store}\nüîó ${promo.productUrl}`;
                    
                    this.showNotification(`üì± Promo√ß√£o compartilhada: ${promo.title}`, 'success');
                    console.log('üì§ Mensagem para WhatsApp:', message);
                }
            }

            deletePromotion(promoId) {
                const promo = this.promotions.find(p => p.id === promoId);
                if (promo && confirm(`‚ùå Tem certeza que deseja excluir "${promo.title}"?`)) {
                    this.showNotification(`üóëÔ∏è Promo√ß√£o "${promo.title}" exclu√≠da com sucesso!`, 'success');
                    this.loadPromotions(); // Recarregar lista
                }
            }

            bulkGenerateAI() {
                const activePromos = this.promotions.filter(p => p.status === 'active' && !p.aiGenerated);
                this.showNotification(`ü§ñ Gerando descri√ß√µes IA para ${activePromos.length} promo√ß√µes...`, 'info');
                
                setTimeout(() => {
                    this.showNotification('‚úÖ Todas as descri√ß√µes IA foram geradas com sucesso!', 'success');
                }, 2000);
            }

            bulkSendWhatsApp() {
                const activePromos = this.promotions.filter(p => p.status === 'active');
                this.showNotification(`üì± Enviando ${activePromos.length} promo√ß√µes via WhatsApp para 2,341 contatos...`, 'info');
                
                setTimeout(() => {
                    this.showNotification('‚úÖ Todas as promo√ß√µes foram enviadas via WhatsApp!', 'success');
                }, 3000);
            }

            exportData() {
                const csvData = this.promotions.map(p => 
                    `"${p.title}","${p.store}","${p.originalPrice}","${p.promoPrice}","${p.discountPercent}%","${p.status}"`
                ).join('\\n');
                
                const header = '"Produto","Loja","Pre√ßo Original","Pre√ßo Promo","Desconto","Status"\\n';
                const blob = new Blob([header + csvData], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `promocoes_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                
                this.showNotification('üìä Dados exportados com sucesso!', 'success');
            }

            updatePrices() {
                this.showNotification('üîÑ Atualizando pre√ßos de todas as promo√ß√µes...', 'info');
                
                setTimeout(() => {
                    this.showNotification('‚úÖ Pre√ßos atualizados! 3 promo√ß√µes tiveram altera√ß√µes.', 'success');
                    this.loadPromotions(); // Recarregar lista
                }, 2500);
            }

            // ========================================
            // üß™ SISTEMA DE TESTES AUTOMATIZADOS
            // ========================================

            async runTests() {
                console.log('üß™ Iniciando testes do sistema de promo√ß√µes...');
                
                const tests = [
                    { name: 'Conectividade Backend', test: () => this.testBackendConnection() },
                    { name: 'Carregamento Promo√ß√µes', test: () => this.testLoadPromotions() },
                    { name: 'Filtros Funcionais', test: () => this.testFilters() },
                    { name: 'Gera√ß√£o IA', test: () => this.testAIGeneration() },
                    { name: 'C√°lculo Descontos', test: () => this.testDiscountCalculations() },
                    { name: 'Formata√ß√£o Pre√ßos', test: () => this.testPriceFormatting() },
                    { name: 'Valida√ß√£o Status', test: () => this.testStatusValidation() }
                ];

                let passed = 0;
                let total = tests.length;

                for (const test of tests) {
                    try {
                        await test.test();
                        console.log(`‚úÖ ${test.name}: PASSOU`);
                        passed++;
                    } catch (error) {
                        console.log(`‚ùå ${test.name}: FALHOU - ${error.message}`);
                    }
                }

                const successRate = ((passed / total) * 100).toFixed(1);
                console.log(`üèÅ Testes conclu√≠dos: ${passed}/${total} (${successRate}%)`);
                
                if (passed === total) {
                    this.showNotification(`‚úÖ Todos os ${total} testes passaram! Sistema funcionando perfeitamente.`, 'success');
                } else {
                    this.showNotification(`‚ö†Ô∏è ${passed}/${total} testes passaram. Verifique o console para detalhes.`, 'warning');
                }
            }

            async testBackendConnection() {
                const result = await this.apiRequest('/health');
                if (!result || result.status !== 'healthy') {
                    throw new Error('Backend n√£o est√° respondendo corretamente');
                }
            }

            async testLoadPromotions() {
                if (this.promotions.length === 0) {
                    throw new Error('Nenhuma promo√ß√£o foi carregada');
                }
                
                const requiredFields = ['id', 'title', 'originalPrice', 'promoPrice', 'discountPercent'];
                const firstPromo = this.promotions[0];
                
                for (const field of requiredFields) {
                    if (!firstPromo.hasOwnProperty(field)) {
                        throw new Error(`Campo obrigat√≥rio '${field}' n√£o encontrado`);
                    }
                }
            }

            testFilters() {
                // Testar se os filtros est√£o funcionando
                const searchInput = document.querySelector('input[placeholder="Buscar promo√ß√µes..."]');
                if (!searchInput) {
                    throw new Error('Campo de busca n√£o encontrado');
                }
            }

            async testAIGeneration() {
                if (this.promotions.length > 0) {
                    const result = await this.generateAIText(this.promotions[0].id);
                    if (!result) {
                        throw new Error('IA n√£o conseguiu gerar texto');
                    }
                }
            }

            testDiscountCalculations() {
                for (const promo of this.promotions) {
                    const expectedDiscount = Math.round((1 - promo.promoPrice / promo.originalPrice) * 100);
                    const tolerance = 1; // 1% de toler√¢ncia
                    
                    if (Math.abs(promo.discountPercent - expectedDiscount) > tolerance) {
                        throw new Error(`Desconto incorreto para ${promo.title}: esperado ~${expectedDiscount}%, obtido ${promo.discountPercent}%`);
                    }
                }
            }

            testPriceFormatting() {
                for (const promo of this.promotions) {
                    if (typeof promo.originalPrice !== 'number' || promo.originalPrice <= 0) {
                        throw new Error(`Pre√ßo original inv√°lido: ${promo.originalPrice}`);
                    }
                    if (typeof promo.promoPrice !== 'number' || promo.promoPrice <= 0) {
                        throw new Error(`Pre√ßo promocional inv√°lido: ${promo.promoPrice}`);
                    }
                    if (promo.promoPrice > promo.originalPrice) {
                        throw new Error(`Pre√ßo promocional maior que original em: ${promo.title}`);
                    }
                }
            }

            testStatusValidation() {
                const validStatuses = ['active', 'inactive', 'expiring_soon'];
                for (const promo of this.promotions) {
                    if (!validStatuses.includes(promo.status)) {
                        throw new Error(`Status inv√°lido: ${promo.status}`);
                    }
                }
            }

            // ========================================
            // üõ†Ô∏è UTILIT√ÅRIOS
            // ========================================

            debounce(func, wait) {
                clearTimeout(this.debounceTimeout);
                this.debounceTimeout = setTimeout(func, wait);
            }

            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg max-w-md transition-all duration-300 ${this.getNotificationClass(type)}`;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.opacity = '0';
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 300);
                }, 4000);
            }

            getNotificationClass(type) {
                const classes = {
                    'success': 'bg-green-500 text-white',
                    'error': 'bg-red-500 text-white',
                    'warning': 'bg-yellow-500 text-black',
                    'info': 'bg-blue-500 text-white'
                };
                return classes[type] || classes.info;
            }

            getFallbackData() {
                // Dados offline de emerg√™ncia
                return {
                    success: true,
                    data: {
                        promotions: [
                            {
                                id: 'offline_001',
                                title: 'Smartphone (Dados Offline)',
                                category: 'Eletr√¥nicos',
                                store: 'Loja Virtual',
                                originalPrice: 999.00,
                                promoPrice: 699.00,
                                discountPercent: 30,
                                imageUrl: 'https://via.placeholder.com/300x300?text=Offline',
                                status: 'active',
                                aiGenerated: false,
                                expiresAt: new Date(Date.now() + 24*60*60*1000).toISOString()
                            }
                        ],
                        pagination: { page: 1, limit: 10, total: 1, pages: 1 }
                    }
                };
            }
        }

        // ========================================
        // üöÄ INICIALIZA√á√ÉO DO SISTEMA
        // ========================================

        document.addEventListener('DOMContentLoaded', function() {
            console.log('üè∑Ô∏è Iniciando Sistema de Gerenciamento de Promo√ß√µes...');
            window.promotionsManager = new PromotionsManager();
        });
    </script>
</body>
</html>